node('words-linux') {         
    try {
       stage('checkout'){
           checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '361885ba-9425-4230-950e-0af201d90547', url: 'https://git.auckland.dynabic.com/words-cloud/words-cloud-node.git']]])
           withCredentials([usernamePassword(credentialsId: '6839cbe8-39fa-40c0-86ce-90706f0bae5d', passwordVariable: 'AppKey', usernameVariable: 'AppSid')]) {
               sh 'echo "{\\"AppSid\\": \\"$AppSid\\",\\"AppKey\\": \\"$AppKey\\"}" > testConfig.json'
           }
		
		sh "git config user.email \"jenkins.aspose@gmail.com\""
		sh "git config user.name \"jenkins\""
       }
       
       docker.image('node:latest').inside{
           stage('build package'){
               withEnv([
               /* Override the npm cache directory to avoid: EACCES: permission denied, mkdir '/.npm' */
               'npm_config_cache=npm-cache',
               /* set home to our current directory because other bower
                * nonsense breaks with HOME=/, e.g.:
                * EACCES: permission denied, mkdir '/.config'
                */
               'HOME=.',
               ]) {
                   sh "npm install"
                   sh "npm run gulp buildRelease"
                   packageName = sh(returnStdout: true, script: 'npm pack').trim()
                   
               }
			
			stash name: "newPackage", includes: "${packageName}"					
           }
		}
	
	    stage('Merge master to testPackage'){			
	    	sh "git checkout --merge testPackage"
	    	sh "git reset --hard origin/testPackage"
	    	sh "git merge --no-ff --allow-unrelated-histories origin/master"
	    	sh "git diff --name-status"			
	    	sh 'git commit -am "Merged master branch to testPackage" || exit 0'
	    	
	    	withCredentials([usernamePassword(credentialsId: '361885ba-9425-4230-950e-0af201d90547', passwordVariable: 'gitPass', usernameVariable: 'gitUsername')]) {
	    		sh "git push https://$gitUsername:$gitPass@git.auckland.dynabic.com/words-cloud/words-cloud-node.git testPackage"
	    	}
	    }
	
	    stage('add reference to new package'){
	    	unstash 'newPackage'	
	    	docker.image('node:latest').inside{
	    		 withEnv([
                   /* Override the npm cache directory to avoid: EACCES: permission denied, mkdir '/.npm' */
                   'npm_config_cache=npm-cache',
                   /* set home to our current directory because other bower
                    * nonsense breaks with HOME=/, e.g.:
                    * EACCES: permission denied, mkdir '/.config'
                    */
                   'HOME=.',
                   ]) {
	    			sh "npm uninstall asposewordscloud"
	    			sh "npm install ${packageName}"
	    		}
	    	}
	    	
	    	sh "git diff --name-status"
			sh "git ls-files --others --exclude-standard"
			sh "git add -A"
	    	sh 'git commit -am "new version of package added to repository" || exit 0'
	    	withCredentials([usernamePassword(credentialsId: '361885ba-9425-4230-950e-0af201d90547', passwordVariable: 'gitPass', usernameVariable: 'gitUsername')]) {
	    		sh "git push https://$gitUsername:$gitPass@git.auckland.dynabic.com/words-cloud/words-cloud-node.git testPackage"
	    	}
	    }
		    			                
    } finally {                       
        deleteDir()
    }
}

stage('test package'){
	build job: 'words-node-sdk', 
	   parameters: [
		string(name: 'branch', value: 'testPackage')						
	   ]
}   

stage('wait for publish confirmation'){
	timeout(time:1, unit:'DAYS') {
		input message:'Publish packet?'
	}
}

node('words-linux') {         
    try {
        stage('checkout again'){
           checkout([$class: 'GitSCM', branches: [[name: '*/testPackage']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '361885ba-9425-4230-950e-0af201d90547', url: 'https://git.auckland.dynabic.com/words-cloud/words-cloud-node.git']]])          
					
			sh "git checkout testPackage"
	    	sh "git reset --hard origin/testPackage"
        }
		
	    stage('publish package'){
			docker.image('node:latest').inside{
				withEnv([
				/* Override the npm cache directory to avoid: EACCES: permission denied, mkdir '/.npm' */
				'npm_config_cache=npm-cache',
					/* set home to our current directory because other bower
					* nonsense breaks with HOME=/, e.g.:
					* EACCES: permission denied, mkdir '/.config'
					*/
				'HOME=.',
				]) {
				withCredentials([string(credentialsId: '19f0eab9-c600-4746-a4bd-724efd2102c8', variable: 'npmToken')]) {
					sh "echo //registry.npmjs.org/:_authToken=$npmToken > .npmrc"
					sh "npm publish ${packageName}"
				}
				}
			}				
		}
		
		stage('change reference to published package'){
			docker.image('node:latest').inside{           
				withEnv([
				/* Override the npm cache directory to avoid: EACCES: permission denied, mkdir '/.npm' */
				'npm_config_cache=npm-cache',
					/* set home to our current directory because other bower
					* nonsense breaks with HOME=/, e.g.:
					* EACCES: permission denied, mkdir '/.config'
					*/
				'HOME=.',
				]) {
                    sh "npm uninstall asposewordscloud"
					sh "npm install asposewordscloud"              
                }				
            }

			sh "git diff --name-status"
	    	sh 'git commit -am "reference changed to published package" || exit 0'
	    	withCredentials([usernamePassword(credentialsId: '361885ba-9425-4230-950e-0af201d90547', passwordVariable: 'gitPass', usernameVariable: 'gitUsername')]) {
	    		sh "git push https://$gitUsername:$gitPass@git.auckland.dynabic.com/words-cloud/words-cloud-node.git testPackage"
	    	}			
		}
		
		stage('add version tag') {
			fullVersion = sh(returnStdout: true, script:'echo $packageName | cut -d @ -f2')
			version = sh(returnStdout: true, script:'echo ${fullVersion%.*}')

			sh "git tag -a $version -m 'version $version'" 
	    	withCredentials([usernamePassword(credentialsId: '361885ba-9425-4230-950e-0af201d90547', passwordVariable: 'gitPass', usernameVariable: 'gitUsername')]) {
	    		sh "git push https://$gitUsername:$gitPass@git.auckland.dynabic.com/words-cloud/words-cloud-node.git $version"
		}
		
    } finally {                       
        deleteDir()
    }
}

stage('test published package'){
	build job: 'words-node-sdk', 
	   parameters: [
		string(name: 'branch', value: 'testPackage')					
	   ]
}   